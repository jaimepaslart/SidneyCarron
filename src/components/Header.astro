---
import { getLangFromUrl, getTranslation, getLocalizedPath } from '@/i18n';
import LanguageToggle from './LanguageToggle.astro';

interface Props {
  alternateHref?: string;
}

const { alternateHref } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = getTranslation(lang);

const navItems = [
  { label: t('nav.works'), href: getLocalizedPath(lang, '/works') },
  { label: t('nav.series'), href: getLocalizedPath(lang, '/series') },
  { label: t('nav.exhibitions'), href: getLocalizedPath(lang, '/exhibitions') },
  { label: t('nav.press'), href: getLocalizedPath(lang, '/press') },
  { label: t('nav.about'), href: getLocalizedPath(lang, '/about') },
  { label: t('nav.contact'), href: getLocalizedPath(lang, '/contact') },
];

const currentPath = Astro.url.pathname;
const homePath = getLocalizedPath(lang, '/');
---

<header
  id="site-header"
  class="sticky top-0 z-50 transition-all duration-base ease-museum"
>
  <div class="museum-container flex items-center justify-between h-16 lg:h-20">
    <a
      href={homePath}
      class="font-sans text-[1.1rem] font-medium tracking-museum uppercase text-museum-text bg-none z-[110]"
    >
      Sidney Carron
    </a>

    <nav class="hidden md:flex items-center gap-5 lg:gap-7" aria-label={t('a11y.main_nav')}>
      {navItems.map(({ label, href }) => {
        const isActive = currentPath === href || (href !== homePath && currentPath.startsWith(href));
        const isContact = href.includes('/contact');
        return isContact ? (
          <a
            href={href}
            class:list={[
              'font-sans text-small font-normal uppercase tracking-widest bg-none transition-colors duration-base ease-museum',
              'border border-current rounded-full px-4 py-1',
              isActive ? 'text-museum-text' : 'text-museum-caption hover:text-museum-text',
            ]}
          >
            {label}
          </a>
        ) : (
          <a
            href={href}
            class:list={[
              'font-sans text-small font-normal uppercase tracking-widest bg-none transition-colors duration-base ease-museum',
              isActive
                ? 'text-museum-text underline underline-offset-[6px] decoration-[1px]'
                : 'text-museum-caption hover:text-museum-text',
            ]}
          >
            {label}
          </a>
        );
      })}
      <LanguageToggle alternateHref={alternateHref} />
    </nav>

    <!-- Hamburger / X toggle -->
    <button
      id="menu-toggle"
      class="md:hidden relative w-10 h-10 flex items-center justify-center z-[110]"
      aria-label={t('a11y.menu_open')}
      aria-expanded="false"
      aria-controls="mobile-menu"
      data-label-open={t('a11y.menu_open')}
      data-label-close={t('a11y.menu_close')}
    >
      <span class="hamburger-line hamburger-line--top" id="menu-line-1"></span>
      <span class="hamburger-line hamburger-line--bottom" id="menu-line-2"></span>
    </button>
  </div>

  <!-- Mobile fullscreen menu -->
  <div
    id="mobile-menu"
    class="mobile-overlay md:hidden"
    aria-hidden="true"
  >
    <nav class="flex flex-col items-center gap-1" aria-label="Menu mobile">
      {navItems.map(({ label, href }, i) => {
        const isContact = href.includes('/contact');
        return (
          <a
            href={href}
            class:list={[
              'mobile-nav-link',
              isContact && 'mobile-nav-contact',
            ]}
            style={`--stagger: ${i}`}
          >
            {label}
          </a>
        );
      })}
    </nav>

    <div class="mobile-nav-link" style={`--stagger: ${navItems.length}`}>
      <LanguageToggle alternateHref={alternateHref} />
    </div>
  </div>
</header>

<style>
  /* --- Hamburger lines --- */
  .hamburger-line {
    position: absolute;
    width: 22px;
    height: 1.5px;
    background-color: #1A1A1A;
    transition: transform 500ms cubic-bezier(0.76, 0, 0.24, 1),
                opacity 300ms ease;
  }

  .hamburger-line--top {
    transform: translateY(-4px);
  }

  .hamburger-line--bottom {
    transform: translateY(4px);
  }

  /* Morphed to X */
  .menu-open .hamburger-line--top {
    transform: translateY(0) rotate(45deg);
  }

  .menu-open .hamburger-line--bottom {
    transform: translateY(0) rotate(-45deg);
  }

  /* --- Fullscreen overlay --- */
  .mobile-overlay {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 2rem;
    background-color: #FAFAF8;

    /* Clip-path circle reveal from top-right */
    clip-path: circle(0% at calc(100% - 2rem) 2rem);
    transition: clip-path 700ms cubic-bezier(0.76, 0, 0.24, 1);

    pointer-events: none;
  }

  .mobile-overlay.is-open {
    clip-path: circle(150% at calc(100% - 2rem) 2rem);
    pointer-events: auto;
  }

  /* --- Nav links: staggered reveal --- */
  .mobile-nav-link {
    font-family: 'Elizeth', 'Georgia', serif;
    font-weight: 300;
    font-size: clamp(1.5rem, 5vw, 2.25rem);
    color: #1A1A1A;
    text-decoration: none;
    background: none;
    letter-spacing: 0.02em;
    padding: 0.4rem 0;
    position: relative;

    opacity: 0;
    transform: translateY(20px);
    transition: opacity 400ms ease, transform 400ms ease, color 300ms ease;
    transition-delay: calc(var(--stagger, 0) * 80ms);
  }

  .mobile-overlay.is-open .mobile-nav-link {
    opacity: 1;
    transform: translateY(0);
  }

  .mobile-nav-link::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 1px;
    background-color: currentColor;
    transform: translateX(-50%);
    transition: width 300ms cubic-bezier(0.76, 0, 0.24, 1);
  }

  .mobile-nav-link:hover::after {
    width: 100%;
  }

  .mobile-nav-link:hover {
    color: #888888;
  }

  /* Contact: pill style */
  .mobile-nav-contact {
    margin-top: 1rem;
    font-family: 'Relative', 'Helvetica Neue', Arial, sans-serif;
    font-size: 0.8rem;
    font-weight: 400;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    border: 1px solid currentColor;
    border-radius: 9999px;
    padding: 0.5rem 2rem;
  }

  .mobile-nav-contact::after {
    display: none;
  }

  .mobile-nav-contact:hover {
    background-color: #1A1A1A;
    color: #FAFAF8;
  }

  /* Logo color when menu is open */
  .menu-open #site-header a:first-child {
    color: #1A1A1A;
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .mobile-overlay {
      clip-path: none;
      opacity: 0;
      transition: opacity 200ms ease;
    }

    .mobile-overlay.is-open {
      opacity: 1;
    }

    .hamburger-line {
      transition: transform 200ms ease;
    }

    .mobile-nav-link {
      opacity: 1;
      transform: none;
      transition: color 200ms ease;
    }
  }
</style>

<script>
  const header = document.getElementById('site-header');
  const menuToggle = document.getElementById('menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  let isOpen = false;

  // Scroll: transparent â†’ white
  function handleScroll() {
    if (!header || isOpen) return;
    if (window.scrollY > 20) {
      header.classList.add('bg-white', 'shadow-sm');
    } else {
      header.classList.remove('bg-white', 'shadow-sm');
    }
  }
  window.addEventListener('scroll', handleScroll, { passive: true });
  handleScroll();

  function openMenu() {
    if (!mobileMenu || !menuToggle) return;
    isOpen = true;
    mobileMenu.classList.add('is-open');
    menuToggle.classList.add('menu-open');
    menuToggle.setAttribute('aria-expanded', 'true');
    menuToggle.setAttribute('aria-label', menuToggle.dataset.labelClose || '');
    mobileMenu.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    // Remove header scroll style during menu
    header?.classList.remove('bg-white', 'shadow-sm');
  }

  function closeMenu() {
    if (!mobileMenu || !menuToggle) return;
    isOpen = false;
    mobileMenu.classList.remove('is-open');
    menuToggle.classList.remove('menu-open');
    menuToggle.setAttribute('aria-expanded', 'false');
    menuToggle.setAttribute('aria-label', menuToggle.dataset.labelOpen || '');
    mobileMenu.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    handleScroll();
  }

  menuToggle?.addEventListener('click', () => {
    isOpen ? closeMenu() : openMenu();
  });

  // Close on link click
  mobileMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  // Close on Escape
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      closeMenu();
    }
  });
</script>
