---
import PageLayout from '@/layouts/PageLayout.astro';
import WorkViewer from '@/components/WorkViewer.astro';
import WorkCard from '@/components/WorkCard.astro';
import { getCollection } from 'astro:content';
import { getTranslation, getLocalizedPath, type Lang } from '@/i18n';

interface Props {
  lang: Lang;
  slug: string;
}

const { lang, slug } = Astro.props;
const t = getTranslation(lang);

const allWorks = await getCollection('works');
const sortedWorks = allWorks.sort((a, b) => a.data.order - b.data.order);

const workIndex = sortedWorks.findIndex(w =>
  (lang === 'en' ? w.data.slug_en : w.data.slug) === slug
);
const work = sortedWorks[workIndex];

if (!work) return Astro.redirect(getLocalizedPath(lang, '/works'));

const prevWork = workIndex > 0 ? sortedWorks[workIndex - 1] : null;
const nextWork = workIndex < sortedWorks.length - 1 ? sortedWorks[workIndex + 1] : null;

const title = lang === 'en' ? work.data.title_en : work.data.title_fr;
const medium = lang === 'en' ? work.data.medium_en : work.data.medium_fr;
const description = lang === 'en' ? work.data.description_en : work.data.description_fr;

const prevTitle = prevWork ? (lang === 'en' ? prevWork.data.title_en : prevWork.data.title_fr) : '';
const nextTitle = nextWork ? (lang === 'en' ? nextWork.data.title_en : nextWork.data.title_fr) : '';

const images = work.data.images.map(img => ({
  src: img.src,
  alt: lang === 'en' ? img.alt_en : img.alt_fr,
}));

const relatedWorks = sortedWorks
  .filter(w => w.data.series === work.data.series && w.data.slug !== work.data.slug)
  .slice(0, 3);

const allSeries = await getCollection('series');
const seriesData = allSeries.find(s => s.data.slug === work.data.series);
const seriesTitle = seriesData ? (lang === 'en' ? seriesData.data.title_en : seriesData.data.title_fr) : '';
const seriesSlug = seriesData ? (lang === 'en' ? seriesData.data.slug_en : seriesData.data.slug) : '';

const details = `${medium}, ${work.data.dimensions}, ${work.data.year}`;

const siteUrl = 'https://sidneycarron.com';

const jsonLd = {
  '@context': 'https://schema.org',
  '@graph': [
    {
      '@type': 'VisualArtwork',
      name: title,
      description: description || `${title}, ${medium}, ${work.data.year}`,
      dateCreated: String(work.data.year),
      artMedium: medium,
      width: work.data.dimensions,
      image: `${siteUrl}${work.data.images[0].src}`,
      url: `${siteUrl}${getLocalizedPath(lang, `/works/${work.data.slug}`)}`,
      creator: {
        '@type': 'Person',
        name: 'Sidney Carron',
        url: siteUrl,
      },
    },
    {
      '@type': 'BreadcrumbList',
      itemListElement: [
        { '@type': 'ListItem', position: 1, name: 'Sidney Carron', item: siteUrl },
        { '@type': 'ListItem', position: 2, name: lang === 'fr' ? 'Œuvres' : 'Works', item: `${siteUrl}${getLocalizedPath(lang, '/works')}` },
        { '@type': 'ListItem', position: 3, name: title },
      ],
    },
  ],
};
---

<PageLayout
  title={`${title} — Sidney Carron`}
  description={description || `${title}, ${medium}, ${work.data.year}`}
  ogImage={work.data.images[0].src}
  canonicalPath={`/works/${work.data.slug}`}
  enCanonicalPath={`/works/${work.data.slug_en}`}
  jsonLd={jsonLd}
>
  <section class="museum-section">
    <div class="museum-container">
      <!-- Split layout: 40% info (sticky) / 60% images -->
      <div class="flex flex-col lg:flex-row lg:gap-16">

        <!-- LEFT COLUMN: Info (sticky on desktop) -->
        <div class="lg:w-[40%] lg:shrink-0">
          <div class="lg:sticky lg:top-32 detail-info">
            <!-- Back link -->
            <a
              href={getLocalizedPath(lang, '/works')}
              class="inline-block font-sans text-small text-museum-label hover:text-museum-text transition-colors duration-base ease-museum mb-8"
            >
              ← {t('works.back')}
            </a>

            <!-- Title -->
            <h1 class="text-h1 font-serif font-light text-museum-text">
              {title}
            </h1>

            <!-- Separator -->
            <div class="h-px bg-[#E8E6E0] my-6"></div>

            <!-- Metadata -->
            <dl class="space-y-4">
              <div>
                <dt class="museum-label">{t('works.year').toUpperCase()}</dt>
                <dd class="museum-mono text-body text-museum-text mt-1">{work.data.year}</dd>
              </div>
              <div>
                <dt class="museum-label">{t('works.medium').toUpperCase()}</dt>
                <dd class="museum-mono text-body text-museum-text mt-1">{medium}</dd>
              </div>
              <div>
                <dt class="museum-label">{t('works.dimensions').toUpperCase()}</dt>
                <dd class="museum-mono text-body text-museum-text mt-1">{work.data.dimensions}</dd>
              </div>
              {seriesData && (
                <div>
                  <dt class="museum-label">{t('works.series').toUpperCase()}</dt>
                  <dd class="mt-1">
                    <a
                      href={getLocalizedPath(lang, `/series/${seriesSlug}`)}
                      class="font-sans text-body text-museum-text"
                    >
                      {seriesTitle}
                    </a>
                  </dd>
                </div>
              )}
            </dl>

            <!-- Separator -->
            {description && <div class="h-px bg-[#E8E6E0] my-6"></div>}

            <!-- Description -->
            {description && (
              <p class="font-sans text-body text-museum-text" style="line-height: 1.7;">
                {description}
              </p>
            )}
          </div>
        </div>

        <!-- RIGHT COLUMN: Images (scrollable) -->
        <div class="lg:w-[60%] mt-10 lg:mt-0">
          <!-- Mobile: horizontal scroll carousel -->
          <div class="flex gap-4 overflow-x-auto snap-x snap-mandatory pb-4 lg:hidden -mx-gutter-sm px-gutter-sm">
            {images.map((img, i) => (
              <button
                class="snap-center shrink-0 w-[85vw] cursor-pointer bg-[#E8E6E0]"
                onclick={`window.openWorkViewer && window.openWorkViewer(${i})`}
                aria-label={`${lang === 'fr' ? 'Agrandir' : 'Enlarge'} — ${img.alt}`}
              >
                <img
                  src={img.src}
                  alt={img.alt}
                  width="800"
                  height="1000"
                  loading={i === 0 ? 'eager' : 'lazy'}
                  class="w-full h-auto object-contain"
                />
              </button>
            ))}
          </div>

          <!-- Desktop: stacked vertical images -->
          <div class="hidden lg:flex lg:flex-col lg:gap-6">
            {images.map((img, i) => (
              <figure class="reveal-horizontal">
                <button
                  class="w-full cursor-pointer bg-[#E8E6E0]"
                  onclick={`window.openWorkViewer && window.openWorkViewer(${i})`}
                  aria-label={`${lang === 'fr' ? 'Agrandir' : 'Enlarge'} — ${img.alt}`}
                >
                  <img
                    src={img.src}
                    alt={img.alt}
                    width="800"
                    height="1000"
                    loading={i === 0 ? 'eager' : 'lazy'}
                    class="w-full h-auto object-contain"
                  />
                </button>
                <figcaption class="museum-mono text-small text-museum-label mt-2">
                  {img.alt}
                </figcaption>
              </figure>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Prev / Next navigation -->
  <nav class="border-t border-[#E8E6E0]" aria-label={lang === 'fr' ? 'Navigation entre œuvres' : 'Works navigation'}>
    <div class="museum-container py-8 flex justify-between items-start">
      {prevWork ? (
        <a
          href={getLocalizedPath(lang, `/works/${lang === 'en' ? prevWork.data.slug_en : prevWork.data.slug}`)}
          class="group font-sans text-caption text-museum-label hover:text-museum-text transition-colors duration-base ease-museum"
        >
          <span>← {t('works.prev')}</span>
          <span class="block museum-mono text-small text-museum-label mt-1">{prevTitle}</span>
        </a>
      ) : <span />}
      {nextWork ? (
        <a
          href={getLocalizedPath(lang, `/works/${lang === 'en' ? nextWork.data.slug_en : nextWork.data.slug}`)}
          class="group font-sans text-caption text-museum-label hover:text-museum-text transition-colors duration-base ease-museum text-right"
        >
          <span>{t('works.next')} →</span>
          <span class="block museum-mono text-small text-museum-label mt-1">{nextTitle}</span>
        </a>
      ) : <span />}
    </div>
  </nav>

  <!-- Related works from same series -->
  {relatedWorks.length > 0 && (
    <section class="museum-section border-t border-[#E8E6E0]">
      <div class="museum-container">
        <p class="museum-label mb-8 md:mb-12">
          {t('works.related').toUpperCase()}
        </p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
          {relatedWorks.map((rw) => (
            <WorkCard
              slug={lang === 'en' ? rw.data.slug_en : rw.data.slug}
              title={lang === 'en' ? rw.data.title_en : rw.data.title_fr}
              year={rw.data.year}
              medium={lang === 'en' ? rw.data.medium_en : rw.data.medium_fr}
              image={{
                src: rw.data.images[0].src,
                alt: lang === 'en' ? rw.data.images[0].alt_en : rw.data.images[0].alt_fr,
              }}
            />
          ))}
        </div>
      </div>
    </section>
  )}

  <WorkViewer images={images} title={title} details={details} />
</PageLayout>

<style>
  /* Left column fade-in on load */
  .detail-info {
    opacity: 0;
    transform: translateY(16px);
    animation: fadeInUp 600ms ease-out 100ms forwards;
  }

  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* reveal-horizontal styles now in global.css */
</style>

<script>
  const images = document.querySelectorAll('.reveal-horizontal');
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          entry.target.classList.add('is-visible');
          observer.unobserve(entry.target);
        }
      });
    },
    { threshold: 0.15, rootMargin: '0px 0px -30px 0px' }
  );
  images.forEach(img => observer.observe(img));
</script>
